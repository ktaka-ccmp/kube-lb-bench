# Repeatability test for LoadBalancer(ipvs)

http request counts are measured for k8s cluster via ipvs using wrk http stress tool.
Each worker pod runs nginx serving IP address of its own(12-14bytes).

```
root@k12:~/kube-lb-bench/Kuruwa# curl -I http://192.168.0.111:8888/
HTTP/1.1 200 OK
Server: nginx/1.13.0
Date: Thu, 11 May 2017 06:56:29 GMT
Content-Type: text/html
Content-Length: 12
Last-Modified: Thu, 11 May 2017 06:39:34 GMT
Connection: keep-alive
ETag: "59140726-c"
Accept-Ranges: bytes

root@k12:~/kube-lb-bench/Kuruwa# curl http://192.168.0.111:8888/
172.16.61.6
```

# 6th_try
While the number of pods are increased, we measured rps for a loadbalancer with having 8 physical cpus(16 with SMT).
The number of pods are increased from 1 to 40.

Target for ipvs:
http://192.168.0.111:8888/

Target for proxy:(ClusterIP)
http://10.254.0.10/

flannel mode: vxlan

## RSS(Hardware Interrupt)

```
root@k11:~# cat /proc/interrupts |egrep eth0|  tr -s ' '
 81: 828643789 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 IR-PCI-MSI-edge eth0-tx-0
 82: 2675800870 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 IR-PCI-MSI-edge eth0-rx-1
 83: 1371008650 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 IR-PCI-MSI-edge eth0-rx-2
 84: 2319515074 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 IR-PCI-MSI-edge eth0-rx-3
 85: 2359559389 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 IR-PCI-MSI-edge eth0-rx-4

root@k11:~# head /proc/irq/{82..85}/smp_affinity
==> /proc/irq/82/smp_affinity <==
0000,00000001

==> /proc/irq/83/smp_affinity <==
0000,00000001

==> /proc/irq/84/smp_affinity <==
0000,00000001

==> /proc/irq/85/smp_affinity <==
0000,00000001
```

## RPS

```
root@k11:~# head /sys/class/net/eth0/queues/rx-*/rps_cpus
==> /sys/class/net/eth0/queues/rx-0/rps_cpus <==
00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,000000fe

==> /sys/class/net/eth0/queues/rx-1/rps_cpus <==
00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,000000fe

==> /sys/class/net/eth0/queues/rx-2/rps_cpus <==
00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,000000fe

==> /sys/class/net/eth0/queues/rx-3/rps_cpus <==
00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,000000fe
```

## RFS

```
root@k11:~# cat /proc/sys/net/core/rps_sock_flow_entries
32768
root@k11:~# head /sys/class/net/eth0/queues/rx-*/rps_flow_cnt
==> /sys/class/net/eth0/queues/rx-0/rps_flow_cnt <==
8192

==> /sys/class/net/eth0/queues/rx-1/rps_flow_cnt <==
8192

==> /sys/class/net/eth0/queues/rx-2/rps_flow_cnt <==
8192

==> /sys/class/net/eth0/queues/rx-3/rps_flow_cnt <==
8192

```

## CPU interrupt statitstics
```
root@k11:~# mpstat -P ALL
Linux 3.16.0-4-amd64 (k11)      05/11/17        _x86_64_        (16 CPU)

16:32:29     CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
16:32:29     all    0.37    0.00    0.45    0.03    0.00    0.56    0.00    0.00    0.00   98.60
16:32:29       0    0.30    0.00    0.24    0.39    0.00    0.52    0.00    0.00    0.00   98.56
16:32:29       1    0.31    0.00    0.22    0.07    0.00    1.16    0.00    0.00    0.00   98.24
16:32:29       2    0.32    0.00    0.20    0.01    0.00    1.18    0.00    0.00    0.00   98.28
16:32:29       3    0.31    0.00    0.19    0.00    0.00    1.20    0.00    0.00    0.00   98.29
16:32:29       4    0.34    0.00    0.34    0.00    0.00    1.25    0.00    0.00    0.00   98.07
16:32:29       5    0.32    0.00    0.21    0.00    0.00    1.21    0.00    0.00    0.00   98.26
16:32:29       6    0.42    0.00    0.63    0.00    0.00    1.24    0.00    0.00    0.00   97.71
16:32:29       7    0.35    0.00    0.28    0.00    0.00    1.20    0.00    0.00    0.00   98.17
16:32:29       8    0.66    0.00    1.31    0.00    0.00    0.00    0.00    0.00    0.00   98.03
16:32:29       9    0.40    0.00    0.62    0.00    0.00    0.00    0.00    0.00    0.00   98.98
16:32:29      10    0.37    0.00    0.49    0.00    0.00    0.00    0.00    0.00    0.00   99.14
16:32:29      11    0.34    0.00    0.44    0.00    0.00    0.00    0.00    0.00    0.00   99.22
16:32:29      12    0.32    0.00    0.41    0.00    0.00    0.00    0.00    0.00    0.00   99.26
16:32:29      13    0.35    0.00    0.41    0.00    0.00    0.00    0.00    0.00    0.00   99.25
16:32:29      14    0.44    0.00    0.70    0.00    0.00    0.00    0.00    0.00    0.00   98.86
16:32:29      15    0.35    0.00    0.47    0.00    0.00    0.00    0.00    0.00    0.00   99.17

root@k11:~# mpstat -I CPU |awk '{printf "%s %-3s %-10s %-10s %-10s %-10s %-10s\n",$1,$2,$19,$20,$21,$22,$23}'
Linux 3.16.0-4-amd64

16:49:40 CPU 81/s       82/s       83/s       84/s       85/s
16:49:40 0   929.42     2983.44    1546.38    2587.51    2631.42
16:49:40 1   0.00       0.00       0.00       0.00       0.00
16:49:40 2   0.00       0.00       0.00       0.00       0.00
16:49:40 3   0.00       0.00       0.00       0.00       0.00
16:49:40 4   0.00       0.00       0.00       0.00       0.00
16:49:40 5   0.00       0.00       0.00       0.00       0.00
16:49:40 6   0.00       0.00       0.00       0.00       0.00
16:49:40 7   0.00       0.00       0.00       0.00       0.00
16:49:40 8   0.00       0.00       0.00       0.00       0.00
16:49:40 9   0.00       0.00       0.00       0.00       0.00
16:49:40 10  0.00       0.00       0.00       0.00       0.00
16:49:40 11  0.00       0.00       0.00       0.00       0.00
16:49:40 12  0.00       0.00       0.00       0.00       0.00
16:49:40 13  0.00       0.00       0.00       0.00       0.00
16:49:40 14  0.00       0.00       0.00       0.00       0.00
16:49:40 15  0.00       0.00       0.00       0.00       0.00

root@k11:~# mpstat -I SCPU
Linux 3.16.0-4-amd64 (k11)      05/11/17        _x86_64_        (16 CPU)

16:50:23     CPU       HI/s    TIMER/s   NET_TX/s   NET_RX/s    BLOCK/s BLOCK_IOPOLL/s  TASKLET/s    SCHED/s  HRTIMER/s      RCU/s
16:50:23       0       0.00      12.09     800.40     565.12       2.12       0.00       1.30      14.10       0.03      12.87
16:50:23       1       0.00      16.13       7.02    1681.44       0.03       0.00       0.00      15.95       0.03      19.40
16:50:23       2       0.00      15.46       7.22    1674.51       0.00       0.00       0.00      15.05       0.03      21.58
16:50:23       3       0.00      15.16       7.22    1675.75       0.00       0.00       0.00      14.74       0.03      21.07
16:50:23       4       0.00      20.71       7.07    1671.56       0.00       0.00       0.00      20.17       0.03      26.90
16:50:23       5       0.00      15.23       6.97    1677.83       0.00       0.00       0.00      14.78       0.03      21.21
16:50:23       6       0.00      17.77       7.25    1667.98       0.00       0.00       0.00      17.28       0.03      25.68
16:50:23       7       0.00      16.48       6.54    1682.95       0.00       0.00       0.00      16.05       0.03      23.18
16:50:23       8       0.00      13.17       0.00       0.08       0.00       0.00       0.00      12.36       0.01      34.84
16:50:23       9       0.00       9.77       0.00       0.04       0.00       0.00       0.00       9.31       0.01      17.44
16:50:23      10       0.00       8.40       0.00       0.04       0.00       0.00       0.00       8.00       0.01      14.29
16:50:23      11       0.00       7.89       0.00       0.05       0.00       0.00       0.00       7.54       0.01      12.03
16:50:23      12       0.00      10.20       0.00       0.06       0.00       0.00       0.00       9.86       0.01      13.15
16:50:23      13       0.00       7.62       0.00       0.05       0.00       0.00       0.00       7.27       0.01      10.86
16:50:23      14       0.00      10.38       0.00       0.05       0.00       0.00       0.00       9.92       0.01      20.05
16:50:23      15       0.00       8.24       0.00       0.05       0.00       0.00       0.00       7.87       0.01      12.35

root@k11:~# mpstat -I SCPU |awk '{printf "%s %-3s %-10s %-10s\n",$1,$2,$4,$5}'
Linux 3.16.0-4-amd64 05/11/17   _x86_64_

16:52:05 CPU TIMER/s    NET_TX/s
16:52:05 0   12.09      802.30
16:52:05 1   16.13      7.04
16:52:05 2   15.47      7.24
16:52:05 3   15.16      7.24
16:52:05 4   20.71      7.09
16:52:05 5   15.23      6.99
16:52:05 6   17.78      7.27
16:52:05 7   16.49      6.56
16:52:05 8   13.17      0.00
16:52:05 9   9.77       0.00
16:52:05 10  8.40       0.00
16:52:05 11  7.89       0.00
16:52:05 12  10.20      0.00
16:52:05 13  7.62       0.00
16:52:05 14  10.38      0.00
16:52:05 15  8.24       0.00

```

# 7th_try

Same with the 6th_try, only with proxy.

# 8th_try

Same with the 6th_try, only with ipvs.


## Node Specs

###  Master node k04
* CPU: Intel(R) Xeon(R) CPU E5-2450 0 @ 2.10GHz x 16(HT)
* Memory: 32GByte

### Worker node k05-k10 
* CPU: Intel(R) Xeon(R) CPU E5-2450 0 @ 2.10GHz x 16(HT)
* Memory: 32GByte

### Loadbalancer node k11
* CPU: Intel(R) Xeon(R) CPU E5-2450 0 @ 2.10GHz x 16(HT)
* Memory: 32GByte

### Benchmarker node k12
* CPU: Intel(R) Xeon(R) CPU E5-2450 0 @ 2.10GHz x 16(HT)
* Memory: 32GByte

## Benchmark Command example

wrk -c800 -t40 -d60s http://172.16.121.2/

